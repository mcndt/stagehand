# Qargo Stagehand Fork - Maintenance Guide

(GENERATED BY CLAUDE CODE)

This document provides instructions for maintaining and publishing the Qargo internal fork of Stagehand to the internal artifact registry.

## Overview

This is a fork of [@browserbasehq/stagehand](https://github.com/browserbase/stagehand) published as `@qargo/stagehand` to the Qargo internal npm registry.

**Registry:** `https://europe-west1-npm.pkg.dev/qargo-internal-libraries/qargo-npm/`

## Prerequisites

- Node.js 20+ installed
- pnpm installed (`npm install -g pnpm`)
- Access to Qargo's Google Cloud Project with Artifact Registry permissions
- Google Cloud SDK (`gcloud`) installed and authenticated

## Authentication

Before publishing, you must authenticate with the Google Artifact Registry:

```bash
# Run from the packages/core directory
cd packages/core
pnpm run artifactregistry-login
```

This will authenticate your npm client with the Qargo artifact registry. You'll need to re-authenticate periodically when your credentials expire.

## Version Numbering Convention

This fork uses the following versioning scheme:

```
<upstream-version>-fork.<fork-iteration>
```

**Examples:**

- `3.0.1-fork.0` - First fork release based on upstream v3.0.1
- `3.0.1-fork.1` - Second fork release (bug fix or internal change)
- `3.0.2-fork.0` - First fork release after updating to upstream v3.0.2

### When to Bump Versions

- **Patch increment** (`-fork.X`): Bug fixes, internal improvements, or small changes
- **Update base version**: When syncing with a new upstream Stagehand release

## Adding Functionality to the Fork

### 1. Create a Feature Branch

```bash
git checkout -b feat/your-feature-name
```

### 2. Make Your Changes

- All core functionality is in `packages/core/lib/v3/`
- Follow the existing code style and conventions
- Keep changes focused and well-documented

### 3. Test Your Changes

```bash
# From the repository root
cd packages/core

# Run type checking
pnpm run typecheck

# Run tests
pnpm run test

# Run local e2e tests
pnpm run e2e:local
```

### 4. Build and Verify

```bash
# Build the package
pnpm run build

# Verify the build output in dist/
ls -la dist/
```

## Bumping the Version

### For Internal Changes (Patch Bump)

1. Update the version in `packages/core/package.json`:

   ```json
   {
     "name": "@qargo/stagehand",
     "version": "3.0.1-fork.1" // Increment the fork number
   }
   ```

2. Document changes in a changelog or commit message

### For Upstream Sync

When updating to a new upstream version:

1. Identify the target upstream version tag:
   - Upstream tags follow the pattern: `@browserbasehq/stagehand@X.X.X`
   - Example: `@browserbasehq/stagehand@3.1.0`

2. Fetch upstream tags:

   ```bash
   # Add upstream remote if not already set
   git remote add upstream https://github.com/browserbase/stagehand.git

   # Fetch all tags from upstream
   git fetch upstream --tags
   ```

3. List available upstream versions:

   ```bash
   # View all upstream release tags
   git tag -l '@browserbasehq/stagehand@*'
   ```

4. Merge or rebase with the specific version tag:

   ```bash
   # Option 1: Merge with specific tag
   git merge @browserbasehq/stagehand@3.1.0

   # Option 2: Rebase onto specific tag
   git rebase @browserbasehq/stagehand@3.1.0
   ```

5. Update version to match new upstream version:

   ```json
   {
     "name": "@qargo/stagehand",
     "version": "3.1.0-fork.0" // New upstream version, reset fork counter
   }
   ```

6. Resolve any conflicts and ensure internal customizations are preserved

7. Test thoroughly after merging

## Publishing to Artifact Registry

### Step-by-Step Publishing Process

1. **Ensure you're on the correct branch:**

   ```bash
   git status
   # Should show your release branch (e.g., chore/qargo-stagehand-3.0.1-release)
   ```

2. **Authenticate with Artifact Registry:**

   ```bash
   cd packages/core
   pnpm run artifactregistry-login
   ```

3. **Clean and rebuild:**

   ```bash
   # From packages/core directory
   rm -rf dist/
   pnpm run build
   ```

4. **Verify package contents:**

   ```bash
   # Check what will be published
   npm pack --dry-run
   ```

5. **Publish to registry:**

   ```bash
   npm publish
   ```

6. **Verify publication:**

   ```bash
   # Check that the package appears in the registry
   npm view @qargo/stagehand
   ```

7. **Tag the release in git:**
   ```bash
   git tag -a v3.0.1-fork.0 -m "Release v3.0.1-fork.0"
   git push origin v3.0.1-fork.0
   ```

### Troubleshooting Publishing Issues

**Authentication Errors:**

```bash
# Re-authenticate
pnpm run artifactregistry-login

# Verify authentication
npm whoami --registry=https://europe-west1-npm.pkg.dev/qargo-internal-libraries/qargo-npm/
```

**Version Already Exists:**

- Bump the fork version number in `package.json`
- You cannot overwrite an existing published version

**Registry Not Found:**

- Verify the `.npmrc` file exists at the repository root:
  ```
  @qargo:registry=https://europe-west1-npm.pkg.dev/qargo-internal-libraries/qargo-npm/
  //europe-west1-npm.pkg.dev/qargo-internal-libraries/qargo-npm/:always-auth=true
  ```

## Using the Fork in Other Projects

In your project's `package.json`:

```json
{
  "dependencies": {
    "@qargo/stagehand": "^3.0.1-fork.0"
  }
}
```

Ensure your project also has the `.npmrc` configured:

```
@qargo:registry=https://europe-west1-npm.pkg.dev/qargo-internal-libraries/qargo-npm/
//europe-west1-npm.pkg.dev/qargo-internal-libraries/qargo-npm/:always-auth=true
```

## Maintenance Checklist

When preparing a new release:

- [ ] Feature/fix branch created and tested
- [ ] Version bumped in `packages/core/package.json`
- [ ] Changes documented (commit messages or CHANGELOG)
- [ ] Build succeeds (`pnpm run build`)
- [ ] Tests pass (`pnpm run test`)
- [ ] Authenticated with artifact registry (`pnpm run artifactregistry-login`)
- [ ] Published to registry (`npm publish`)
- [ ] Git tag created and pushed
- [ ] Dependent projects notified of new version

## Key Files

- `packages/core/package.json` - Package metadata and version
- `.npmrc` - Registry configuration (at repository root)
- `packages/core/lib/v3/` - Core implementation
- `packages/core/dist/` - Build output (generated, not committed)

## Getting Help

- **Upstream Issues:** https://github.com/browserbase/stagehand/issues
- **Upstream Docs:** https://docs.stagehand.dev
- **Internal Questions:** Contact the Qargo platform team

## Related Branches

- `chore/vertex-ai-support-qargo-internal-release` - Previous fork (v2.5.2)
- `chore/qargo-stagehand-3.0.1-release` - Previous fork (v3.0.1)
- `chore/qargo-stagehand-3.0.8-release` - Current fork (v3.0.8)
